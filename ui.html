<div id="container">
  <div id="preview"></div>
  <div id="value"></div>
</div>
<input id="curvature" type="range" min="0.5" max="1.5" step="0.01" value="1" />
<button id="create">Create</button>

<style>
  #curvature,
  #create {
    display: block;
    width: 100%;
  }

  #preview {
    width: 100%;
    height: 140px;
  }

  #container {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #value {
    position: absolute;
    color: white;
    font-family: sans-serif;
    font-size: 24px;
    font-weight: 300;
  }
</style>

<script>
  function createSquirclePath({
    width,
    height,
    viewBox = [],
    curvature,
    rotate,
  }) {
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    const cx = width / 2;
    const cy = height / 2;
    const viewWidth = viewBox[2];
    const viewHeight = viewBox[3];
    const arc = Math.min(cx, cy) * (1 - curvature);

    const d = `
      M 0 ${cy}
      C 0 ${arc}, ${arc} 0, ${cx} 0
      S ${width} ${arc}, ${width} ${cy}, ${width - arc} ${height}
        ${cx} ${height}, 0 ${height - arc}, 0 ${cy}
    `;

    const transform = `
      rotate(${rotate}, ${cx}, ${cy})
      translate(${(viewWidth - width) / 2}, ${(viewHeight - height) / 2})
    `;

    path.setAttribute("d", d);
    path.setAttribute("transform", transform);
    return path;
  }

  function createSquircleSVG({ width, height, path }) {
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
    svg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
    svg.setAttribute("version", "1.1");
    svg.appendChild(path);
    return svg;
  }

  function createSquircle({
    viewBox = [0, 0, 200, 100],
    width = 75,
    height = 75,
    curvature = 1,
    fill = "#FFB400",
    rotate = 0,
  }) {
    const path = createSquirclePath({
      width,
      height,
      viewBox,
      curvature,
      rotate,
    });

    path.setAttribute("fill", fill);
    path.id = "squircle";

    const squircleSVG = createSquircleSVG({
      width: viewBox[2],
      height: viewBox[3],
      path,
    });

    return squircleSVG;
  }

  document.getElementById("curvature").oninput = (e) => {
    const curvature = Number(e.target.value);
    const squircleSVG = createSquircle({ curvature });
    document.getElementById("value").textContent = curvature.toFixed(2);
    document.getElementById("preview").innerHTML = squircleSVG.outerHTML;
  };

  document.getElementById("create").onclick = () => {
    const squircle = document.getElementById("squircle").outerHTML;
    const pluginMessage = { type: "create-squircle", squircle };
    parent.postMessage({ pluginMessage }, "*");
  };

  const squircleSVG = createSquircle({});
  document.getElementById("value").textContent = "1.00";
  document.getElementById("preview").innerHTML = squircleSVG.outerHTML;
</script>
